#!/usr/bin/env sh

################################################################################
# PRO: Multi-Subcommand Provisioning Tool
# ---------------------------------------
# Usage:
#   ./pro [subcommand] [options]
#
# Subcommands:
#   digitalocean  Provision a DigitalOcean droplet (default)
#   aws           Provision an AWS EC2 instance (future)
#   azure         Provision an Azure VM (future)
#
################################################################################

# Global defaults
DEFAULT_BRANCH="main"
DEFAULT_PLAYBOOK_PATH="src/pro"
DEFAULT_DROPLET_NAME="QuickSearch"
DEFAULT_DROPLET_IMAGE="centos-stream-9-x64"
DEFAULT_REGION="sfo3"
DEFAULT_SIZE="s-1vcpu-1gb"
DEFAULT_PRIVATE_KEY="${DEFAULT_PRIVATE_KEY-$HOME/.ssh/id_rsa}"
DEFAULT_TAGS="pro"

# Help message for main script
usage() {
  cat <<EOF
PRO: Multi-Subcommand Provisioning Tool

Usage:
  $0 [subcommand] [options]

Subcommands:
  digitalocean  Provision a DigitalOcean droplet (default)
  aws           Provision an AWS EC2 instance (future)
  azure         Provision an Azure VM (future)

Examples:
  $0 digitalocean --repo GistWiz/cli --name QuickSearch --tags custom-tag1,custom-tag2
EOF
}

# Validate and process repository input
validate_and_get_repo_url() {
  local repo="$1"

  if [ -z "$repo" ]; then
    echo "Error: The --repo option is required."
    exit 1
  fi

  case "$repo" in
    http*://*) echo "$repo" ;;
    *) echo "https://github.com/$repo.git" ;;
  esac
}

# Generate Cloud Init script
generate_cloud_init() {
  local repo_url="$1"
  local branch="$2"
  local playbook_path="$3"

  cat <<EOF
#cloud-init
packages:
  - epel-release
  - ansible
  - git

runcmd:
  - git clone -b $branch $repo_url /opt/ansible || (cd /opt/ansible && git pull)
  - cd /opt/ansible/$playbook_path
  - ansible-playbook -i "localhost," -c local playbook.yml
EOF
}

# Tag processor to combine defaults, provider-specific, and CLI tags
process_tags() {
  local provider_tag="$1"
  local cli_tags="$2"

  # Combine default tags with provider-specific and CLI-provided tags
  local combined_tags="$DEFAULT_TAGS"
  if [ -n "$provider_tag" ]; then
    combined_tags="$combined_tags,$provider_tag"
  fi
  if [ -n "$cli_tags" ]; then
    combined_tags="$combined_tags,$cli_tags"
  fi

  echo "$combined_tags"
}

# DigitalOcean provider logic
pro_digitalocean() {
  local REPO=""
  local TAGS=""
  while [ "$#" -gt 0 ]; do
    case $1 in
      -r|--repo) REPO="$2"; shift ;;
      -b|--branch) BRANCH="$2"; shift ;;
      -p|--playbook-path) PLAYBOOK_PATH="$2"; shift ;;
      -n|--name) DROPLET_NAME="$2"; shift ;;
      -R|--region) REGION="$2"; shift ;;
      -s|--size) SIZE="$2"; shift ;;
      -k|--private-key) PRIVATE_KEY="$2"; shift ;;
      --tags) TAGS="$2"; shift ;;
      -h|--help) usage; exit 0 ;;
      *) echo "Unknown option: $1"; usage; exit 1 ;;
    esac
    shift
  done

  REPO_URL=$(validate_and_get_repo_url "$REPO")

  BRANCH="${BRANCH-$DEFAULT_BRANCH}"
  PLAYBOOK_PATH="${PLAYBOOK_PATH-$DEFAULT_PLAYBOOK_PATH}"
  DROPLET_NAME="${DROPLET_NAME-$DEFAULT_DROPLET_NAME}"
  DROPLET_IMAGE="${DROPLET_IMAGE-$DEFAULT_DROPLET_IMAGE}"
  REGION="${REGION-$DEFAULT_REGION}"
  SIZE="${SIZE-$DEFAULT_SIZE}"
  PRIVATE_KEY="${PRIVATE_KEY-$DEFAULT_PRIVATE_KEY}"

  if [ ! -f "$PRIVATE_KEY" ]; then
    echo "Error: Private key file '$PRIVATE_KEY' not found."
    exit 1
  fi

  # Process all tags, adding "digitalocean" for this provider
  ALL_TAGS=$(process_tags "digitalocean" "$TAGS")

  echo "Generating Cloud Init script for DigitalOcean..."
  cloud_init=$(generate_cloud_init "$REPO_URL" "$BRANCH" "$PLAYBOOK_PATH")

  echo "Creating DigitalOcean droplet '$DROPLET_NAME' in region '$REGION' with tags: $ALL_TAGS..."
  create_output=$(doctl compute droplet create "$DROPLET_NAME" \
    --region "$REGION" \
    --image "$DROPLET_IMAGE" \
    --size "$SIZE" \
    --ssh-keys $(doctl compute ssh-key list --format ID --no-header | tr '\n' ',') \
    --user-data "$cloud_init" \
    --tag-names "$ALL_TAGS" 2>&1)

  if [ $? -ne 0 ]; then
    echo "Error: Failed to create droplet. Output:"
    echo "$create_output"
    exit 1
  fi

  echo "Droplet '$DROPLET_NAME' created successfully with tags: $ALL_TAGS."
}

# Placeholder for AWS provider
pro_aws() {
  echo "AWS provider support is not implemented yet."
  exit 1
}

# Placeholder for Azure provider
pro_azure() {
  echo "Azure provider support is not implemented yet."
  exit 1
}

# Main function
main() {
  local subcommand="${1-digitalocean}"
  shift || true

  case "$subcommand" in
    digitalocean) pro_digitalocean "$@" ;;
    aws) pro_aws "$@" ;;
    azure) pro_azure "$@" ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown subcommand: $subcommand"; usage; exit 1 ;;
  esac
}

main "$@"